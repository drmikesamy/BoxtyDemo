@page "/calendar"
@using Boxty.ClientBase.Components.Calendar
@using Boxty.ClientBase.Components.Calendar.Events
@using Boxty.ClientBase.Services
@using Boxty.SharedBase.Interfaces
@using Boxty.SharedBase.Models
@using Boxty.SharedApp.DTOs.Calendar
@using Boxty.SharedApp.DTOs.UserManagement

@inject ICrudService<AppointmentDto> AppointmentLookupService
@inject ICrudService<SubjectDto> SubjectLookupService

<PageTitle>Calendar</PageTitle>

@if (_resources.Any())
{
    <MultiResourceCalendar 
        TResource="SubjectCalendarResource"
        TCalendarItem="AppointmentDto" 
        TDocumentDto="SubjectDocumentDto"
        Resources="_resources"
        CellClickedCallback="OnCellClicked"
        ItemClickedCallback="OnItemClicked" />
}
else
{
    <MudText>Loading calendar...</MudText>
}

@code {
    private List<SubjectCalendarResource> _resources = new();
    
    public class SubjectCalendarResource : SubjectDto, ICalendarResource<AppointmentDto>
    {
        public IEnumerable<AppointmentDto> CalendarItems { get; set; } = new List<AppointmentDto>();
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCalendarData();
    }

    private async Task LoadCalendarData()
    {
        var cancellationToken = CancellationToken.None;
        
        // Load subjects (resources)
        var subjects = await SubjectLookupService.GetAllItems(cancellationToken, null, null);
        
        // Load all appointments
        var appointments = await AppointmentLookupService.GetAllItems(cancellationToken, null, null);
        
        // Map subjects to calendar resources with their appointments
        _resources = subjects.Select(subject => new SubjectCalendarResource
        {
            Id = subject.Id,
            FirstName = subject.FirstName,
            LastName = subject.LastName,
            AvatarImageGuid = subject.AvatarImageGuid,
            AvatarImage = subject.AvatarImage,
            AvatarTitle = subject.AvatarTitle,
            AvatarDescription = subject.AvatarDescription,
            CalendarItems = appointments.Where(a => a.SubjectId == subject.Id).ToList()
        }).ToList();
    }

    private void OnCellClicked(CellClickedEventArgs<SubjectCalendarResource, AppointmentDto> args)
    {
        // Handle cell click - create new appointment
    }

    private void OnItemClicked(ItemClickedEventArgs<AppointmentDto> args)
    {
        // Handle item click - view/edit appointment
    }
}
